---
title: Anti UPX 
time: 2025-03-05
categories: [reverse]
tags: [medium]
image: /assets/posts/chall_category/rev.jpg
---

## Description:

A simple packed binary? Think again! This executable claims to be UPX-packed, but something isn’t quite right. Standard UPX tools fail to unpack it, perhaps trying to unpack manually able to reveal the flag. 

- Category: Reverse
- **Flag format:** FLAG{[a-zA-Z0-9]+\}

<button onclick="downloadFile()">Download File</button>

<script>
function downloadFile() {
    const link = document.createElement('a');
    link.href = 'https://github.com/0x251e-challenge/challenges/raw/main/union-depository/reverse/anti-upx/anti-upx.exe';
    link.download = 'anti-upx.exe';
    link.click();
}
</script>

# Solution:

![anti-upx1](/assets/posts/chall-writeup-img/anti-upx/anti-upx1.jpg)

The executable accepts a flag string as arguments. Before decompiling with IDA, run DIE to understand static properties of the executable. 

![anti-upx2](/assets/posts/chall-writeup-img/anti-upx/anti-upx2.jpg)

From the output, we notice is packed with UPX. Trying to unpack with upx will return error as the section header is corrupted. 

```
C:\Users\trevorphilips\Desktop
λ upx -d anti-upx.exe
                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2024
UPX 4.2.4       Markus Oberhumer, Laszlo Molnar & John Reiser    May 9th 2024

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
upx: anti-upx.exe: CantUnpackException: file is modified/hacked/protected; take care!!!

Unpacked 0 files.
```

Use CFF Explorer to check the section headers. 

![anti-upx3](/assets/posts/chall-writeup-img/anti-upx/anti-upx3.jpg)

Normally, UPX packed binary will have UPX with indexed as magic number for marking the section header. Here is an example of a uncorrupted UPX packed section header. 

![anti-upx4](/assets/posts/chall-writeup-img/anti-upx/anti-upx4.jpg)

UPX will only unpack the executable if the section headers contain the standard UPX section names for identification purposes:
- `UPX0`: Containing compressed `.text` section
- `UPX1`: Rest of the paced data (`.data`,`.rdata`,etc)
- `UPX2`: Is optional, appears for extra section if contain from the original unpacked executable

Next, we have to dump the unpacked binary from memory when debugging it with x32dbg along with OllydumpEx and Scylla. 

Before proceeding, lets try to see the function names contains at the packed executable in IDA. 

![anti-upx5](/assets/posts/chall-writeup-img/anti-upx/anti-upx5.jpg)

Here we can see the function `start` at (0x00424940, also similar to the output of DIE indicating the entry point), which serves as the main entry point for execution.  Since this binary was originally UPX-packed but has had its section headers modified to "ANTI", this makes standard UPX unpacking to fail. 

Load it into x32dbg, the first breakpoint it will hit at the module ntdll.dll. Hit run again will bring into the entry point of the executable. 

![anti-upx6](/assets/posts/chall-writeup-img/anti-upx/anti-upx6.jpg)

If comparing IDA and x32dbg side by side, notice that assembly instruction used for UPX entryp point is `pushad`. It uses `pushad` to preserve register states during unpacking the stub. After unpacking, it will continue with `popad` and a `jmp` or `call` to transfer control to the **Original Entry Point (OEP)** of the unpacked binary. 

Next, use Find Command function to search for `popad` instruction and set a breakpoint there. 

![anti-upx7](/assets/posts/chall-writeup-img/anti-upx/anti-upx7.jpg)

Now, it has completed unpacking process, the next instruction will be `jmp` to transfer execution to the OEP. To summarize the UPX unpacking process:
1. `pushad` - storing registers onto the stack for unpacking process
2. unpacking process starts by decompress the packed sections into the memory 
3. `popad` - restore back the registers 
4. `jmp OEP` - redirects instruction execution 

Now, we can step into the `jmp` instruction, with using search strings function within the current module, we able to see strings that is used to prompt in the beginning of running test input.

![anti-upx8](/assets/posts/chall-writeup-img/anti-upx/anti-upx8.jpg)

Next, dump the process using `OllyDump`
